name: CI

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM
        run: cargo cyclonedx --format json

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Snyk Code Scan
        if: env.SNYK_TOKEN != ''
        run: snyk code test --severity-threshold=high --org=${{ secrets.SNYK_ORG }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk SBOM Scan
        if: env.SNYK_TOKEN != ''
        run: snyk sbom test --file=robustack-dl.cdx.json --severity-threshold=high --org=${{ secrets.SNYK_ORG }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # - name: Run Gitleaks
      #   uses: gitleaks/gitleaks-action@v2
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: ${{ github.event.pull_request.head.sha }}

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo-audit
        run: cargo audit

      - name: Cargo Deny
        uses: EmbarkStudios/cargo-deny-action@v2

  compliance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check for AI Provenance Header
        run: |
          FAIL=0
          while IFS= read -r -d '' file; do
            if ! grep -q "AI PROVENANCE" "$file"; then
              echo "::error file=${file}::Missing AI Provenance Header"
              FAIL=1
            fi
          done < <(find src -name "*.rs" -print0)
          exit "$FAIL"

  build:
    runs-on: ubuntu-latest
    needs: [compliance]
    outputs:
      hashes: ${{ steps.hash.outputs.hashes }}
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Clippy (pedantic)
        run: cargo clippy -- -D warnings -W clippy::pedantic

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

      - name: Build Release
        if: startsWith(github.ref, 'refs/tags/v')
        run: cargo build --release

      - name: Generate binary hash
        id: hash
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "hashes=$(sha256sum target/release/robustack-dl | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Upload Binary for Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v6
        with:
          name: robustack-dl
          path: target/release/robustack-dl
          if-no-files-found: error

  provenance:
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v2.1.0
    with:
      base64-subjects: "${{ needs.build.outputs.hashes }}"
      upload-assets: true

  release:
    needs: [security, build, provenance]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download Binary
        uses: actions/download-artifact@v7
        with:
          name: robustack-dl

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM
        run: cargo cyclonedx --format json

      - name: Generate Checksums
        run: |
          sha256sum robustack-dl* > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            robustack-dl
            robustack-dl.cdx.json
            checksums.txt
          generate_release_notes: true
